# План миграции UPAK с OpenAI на Yandex GPT

## Обзор

Данный документ описывает поэтапную миграцию системы UPAK с OpenAI GPT на Yandex GPT для экономии 30-35% затрат и улучшения качества русскоязычного контента.

## Этапы миграции

### ЭТАП 1: Подготовительный (1-2 недели) ✅

**Цели:**
- Создать инфраструктуру для безопасной миграции
- Подготовить код для работы с Yandex GPT
- Настроить тестовую среду

**Выполненные задачи:**
- ✅ Создана ветка `feature/yandex-gpt-migration`
- ✅ Реализован wrapper класс `YandexGPTService` для унификации API
- ✅ Создан `UnifiedAIService` для управления провайдерами
- ✅ Настроена система мониторинга (Prometheus + Grafana)
- ✅ Созданы сравнительные тесты качества генерации
- ✅ Добавлена поддержка feature flags для управления миграцией
- ✅ Настроен Docker и docker-compose для развертывания

**Файлы:**
- `app/ai_providers/yandex_gpt_wrapper.py` - Wrapper для Yandex GPT API
- `app/ai_providers/unified_ai_service.py` - Унифицированный сервис
- `tests/test_generation_quality.py` - Тесты сравнения качества
- `scripts/migration_control.py` - Скрипт управления миграцией

### ЭТАП 2: Пилотное внедрение (2-3 недели)

**Цели:**
- Запустить A/B тестирование 50/50
- Собрать метрики производительности
- Получить обратную связь от пользователей

**Задачи:**
- [ ] Развернуть систему в тестовой среде
- [ ] Включить A/B тестирование с равным распределением
- [ ] Настроить сбор метрик качества и производительности
- [ ] Провести нагрузочное тестирование
- [ ] Собрать обратную связь от пользователей

**Команды для управления:**
```bash
# Включение A/B тестирования 50/50
python scripts/migration_control.py --stage 1

# Проверка статуса
python scripts/migration_control.py --status

# Мониторинг метрик
# Grafana: http://localhost:3000
# Prometheus: http://localhost:9090
```

### ЭТАП 3: Постепенная миграция (2-3 недели)

**Цели:**
- Увеличить долю Yandex GPT до 75%
- Перевести 100% текстовой генерации на Yandex GPT
- Сохранить DALL-E для изображений

**Задачи:**
- [ ] Увеличить долю Yandex GPT до 75%
- [ ] Провести анализ качества и производительности
- [ ] При успешных результатах - полная миграция текстовой генерации
- [ ] Обновить документацию API
- [ ] Провести финальное нагрузочное тестирование

**Команды:**
```bash
# Увеличение доли Yandex GPT до 75%
python scripts/migration_control.py --stage 2

# Полная миграция текстовой генерации
python scripts/migration_control.py --stage 3
```

### ЭТАП 4: Финальная унификация (2-3 недели)

**Цели:**
- Исследовать альтернативы DALL-E
- Оптимизировать промпты для Yandex GPT
- Создать единую систему управления ИИ

**Задачи:**
- [ ] Исследовать Kandinsky для генерации изображений
- [ ] Оптимизировать промпты специально для Yandex GPT
- [ ] Создать единую систему управления всеми ИИ сервисами
- [ ] Обновить мониторинг и аналитику
- [ ] Финальная оптимизация производительности

## Критерии успеха

### Производительность
- Время генерации текста ≤ текущего уровня OpenAI
- Доступность системы ≥ 99.5%
- Отсутствие критических ошибок

### Качество
- Качество русскоязычного контента ≥ OpenAI
- Соответствие промптам ≥ 95%
- Отсутствие неприемлемого контента

### Экономика
- Снижение затрат на 30-35%
- ROI миграции > 200% в течение 6 месяцев

## Процедура отката

### Автоматический откат
```bash
# Немедленный откат к OpenAI
python scripts/migration_control.py --rollback

# Перезапуск сервиса
docker-compose restart upak-backend
```

### Критерии для отката
- Увеличение времени ответа > 50%
- Снижение качества контента
- Критические ошибки в Yandex GPT API
- Недоступность сервиса > 5 минут

## Мониторинг

### Ключевые метрики
- `upak_ai_generations_total` - Количество генераций по провайдерам
- `upak_ai_generation_duration_seconds` - Время генерации
- `upak_ai_generation_errors_total` - Ошибки по провайдерам
- `upak_ab_test_requests_total` - Распределение A/B тестов

### Дашборды
- **Grafana Dashboard**: Визуализация всех метрик миграции
- **Prometheus Alerts**: Автоматические уведомления о проблемах

## Безопасность

### Резервное копирование
- Автоматическое создание backup конфигурации
- Сохранение логов всех изменений
- Возможность быстрого отката

### Тестирование
- Автоматические тесты качества генерации
- Нагрузочное тестирование
- Мониторинг в реальном времени

## Контакты и поддержка

- **Техническая поддержка**: Команда разработки UPAK
- **Мониторинг**: DevOps команда
- **Принятие решений**: Продуктовая команда

---

*Документ обновлен: 7 августа 2025*
*Версия: 1.0*